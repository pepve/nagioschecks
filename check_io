#!/bin/bash

. $(dirname $0)/lib.sh

if [ -z "$1" -o "$2" ]; then
	echo "Usage: $0 <device>"
	exit $STATE_UNKNOWN
fi

DEV=$1
STATE=/var/lib/nagioschecks/check_io_$DEV

if [ ! -f $STATE ]; then
	cat /sys/block/$DEV/stat > $STATE || exit 1
	echo "OK - State initialized on first call, now call again"
	exit $STATE_OK
fi

LAST=($(mtime_cat $STATE))
cat /sys/block/$DEV/stat > $STATE
CURRENT=($(mtime_cat $STATE))

TIME=$((${CURRENT[0]} - ${LAST[0]}))
READ=$(((${CURRENT[3]} - ${LAST[3]}) * 512 / TIME))
WRTN=$(((${CURRENT[7]} - ${LAST[7]}) * 512 / TIME))

echo "OK - $(bytes_to_human $READ)/s read - $(bytes_to_human $WRTN)/s written - \
averaged over $((TIME / 60)):$(printf %02d $((TIME % 60))) minutes|\
read=${READ}B wrtn=${WRTN}B"

exit $STATE_OK
